<!DOCTYPE html>
<html lang="en-us">
<head>
	<title>Menupoly</title>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
	<link href="https://fonts.googleapis.com/css?family=Sedgwick+Ave+Display" rel="stylesheet">
	<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

	<!-- Pre requisites for Google Sign In -->
	<meta name="google-signin-client_id" content="6593651812-g6n1kkdkvnet3e1v3f10jnbleqkq6137.apps.googleusercontent.com">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
  	</script>
	<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
	</script>
</head>

<body>
	<header>
		<!-- User Authentication -->
		<div class="login-bar">
		{% if user != None %}
			<p class="welcome">
				Welcome, {{ user }}!
				<span class="logout">
					<a href="#" onclick="signOut();">Log Out</a>
					<script>
						function signOut() {
							var auth2=gapi.auth2.getAuthInstance();
							auth2.signOut().then(function() {
								console.log('User signed out.');
							})

							$.ajax({
								type: 'POST',
								url: '/gdisconnect',
								processData: false,
								contentType: 'application/octet-stream; charset=utf-8',
								success: function(result) {
									if (result) {
										window.location.href = "{{ url_for('newMenuItem', restaurant_id=restaurant.id) }}";
									}
								}
							})
						}
					</script>
				</span>
			</p>

		{% endif %}

			<div id="signInButtons">
				<span class="g-signin2"
					data-scope="https://www.googleapis.com/auth/plus.login"
					data-redirecturi="postmessage"
					data-accesstype="offline"
					data-cookiepolicy="single_host_origin"
					data-onsuccess="onSignIn"
					data-onfailure="onSignInFailure">
				</span>
			</div>
	
			<script>
				function onSignIn(googleUser) {
					$('#signInButtons').attr('style', 'display: none');
					{% if user == None %}
					setTimeout(function(){
						window.location.href = "{{ url_for('newMenuItem', restaurant_id=restaurant.id) }}"
					}, 1000);
					
					var auth = googleUser.getAuthResponse();
					var id_token = auth.id_token;
					console.log('Sign in successful.')

					$.ajax({
						type: 'POST',
						url: '/gconnect?state={{STATE}}',
						processData: false,
						contentType: 'application/octet-stream; charset=utf-8',
						data: id_token,
						success: function(result) {
							if (result) {
								console.log('OK from server.');
							} else {
								console.log('Error processing login');
							}
						}
					})
					{% endif %}
				}

				function onSignInFailure() {
					$('.login-bar').html('Sign in failed -- please try again.');
					setTimeout(function(){
						window.location.href = "{{ url_for('newMenuItem', restaurant_id=restaurant.id) }}"
					}, 1000);
				}
			</script>
		</div>
		<!-- End User Authentication -->

		<!-- Title and Message Flashing -->
		<h1 class="main-head"><a href ="{{ url_for('showRestaurants') }}">Menupoly</a></h1>
		{%  with messages = get_flashed_messages() %}
		{%  if messages %}
			<ul class="flash">
			{% for message in messages %}
				<li><strong>{{ message }}</strong></li>
			{% endfor %}
			</ul>
		{% endif %}
		{% endwith %}
		<!-- End Title and Message Flashing -->
	</header>
	
	<div class="form">
	{% if user != None %}
		{% if user_id == restaurant.user_id or user_id == 2 %}
		<h2>Adding a New Menu Item to {{restaurant.name}}</h2>
		<form action="{{ url_for('newMenuItem', restaurant_id=restaurant.id) }}" method="post">
			<p>Name: <input type="text" size="30" name="name"></p>
			<p>Course: <select name="course">
				<option value="Entree">Entree</option>
				<option value="Appetizer">Appetizer</option>
				<option value="Dessert">Dessert</option>
				<option value="Beverage">Beverage</option>
			</select></p>
			<p>Price: <input type="text" size="30" name="price"></p>
			<p>Description: </p>
			<textarea name="description" rows="2" cols="50"></textarea>
			<p><input type='submit' value='Add'></p>
		</form>
		<p class="cancel"><a href="{{ url_for('showMenuItems', restaurant_id=restaurant.id)}}">Cancel</a></p>

		{% else %}
		<p class="error">You are not authorized to add items to this restaurant.</p>
		<p class="cancel"><a href="{{ url_for('showMenuItems', restaurant_id=restaurant.id)}}">Cancel</a></p>
		{% endif %}

	{% else %}
		<p class="error">You must be logged in to add menu items.</p>
		<p class="cancel"><a href="{{ url_for('showMenuItems', restaurant_id=restaurant.id)}}">Cancel</a></p>
	{% endif %}
	</div>
</body>
</html>